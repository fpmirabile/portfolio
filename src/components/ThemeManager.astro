---
// This component handles global theme management
// It should be included once in the main layout
---

<script>
  import { getCurrentLanguage } from "../utils/language";
  import { eventHandlers } from "../utils/events";
  import type { SupportedLanguage } from "../types";

  class ThemeManager {
    private isDark: boolean = false;
    private currentLanguage: SupportedLanguage = "es";

    constructor() {
      this.initializeTheme();
      this.initializeLanguage();
      this.setupEventListeners();
    }

    private initializeTheme() {
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme) {
        this.isDark = savedTheme === "dark";
      } else {
        this.isDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
      }
      this.updateTheme();
    }

    private initializeLanguage() {
      this.currentLanguage = getCurrentLanguage();
      localStorage.setItem("language", this.currentLanguage);
    }

    private updateTheme() {
      document.documentElement.classList.toggle("dark", this.isDark);
      eventHandlers.themeChanged(this.isDark);
    }

    private setupEventListeners() {
      // Theme toggle
      document.addEventListener("toggleTheme", () => {
        this.toggleTheme();
      });

      // Listen to system theme changes
      window
        .matchMedia("(prefers-color-scheme: dark)")
        .addEventListener("change", (e) => {
          if (!localStorage.getItem("theme")) {
            this.isDark = e.matches;
            this.updateTheme();
          }
        });
    }

    public toggleTheme() {
      this.isDark = !this.isDark;
      this.updateTheme();
      localStorage.setItem("theme", this.isDark ? "dark" : "light");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    new ThemeManager();
  });
</script>
