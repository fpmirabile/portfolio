---
import {
  Download,
  Github,
  Linkedin,
  Mail,
  Menu,
  Moon,
  Sun,
  X,
} from "lucide-astro";
import MenuItem from "../common/MenuItem.astro";
import type { MenuTexts } from "../../types";

export interface Props {
  texts: MenuTexts;
}

const { texts } = Astro.props;
---

<div class="fixed top-6 right-6 z-50">
  <!-- Menu Items -->
  <div
    id="menuItems"
    class="absolute top-16 right-0 space-y-3 pointer-events-none"
  >
    <!-- CV Download -->
    <MenuItem
      as="button"
      id="cvButton"
      title={texts.cvText}
      subtitle={texts.cvSubtitle}
    >
      <Download class="w-4 h-4 text-primary" slot="icon" aria-hidden="true" />
    </MenuItem>

    <!-- Email -->
    <MenuItem
      href="mailto:fpmirabile@gmail.com"
      title={texts.emailTitle}
      subtitle={texts.emailSubtitle}
    >
      <Mail class="w-4 h-4 text-primary" slot="icon" aria-hidden="true" />
    </MenuItem>

    <!-- LinkedIn -->
    <MenuItem
      href="https://www.linkedin.com/in/fernando-pablo-mirabile-viola-85a64a52"
      target="_blank"
      title={texts.linkedinTitle}
      subtitle={texts.linkedinSubtitle}
    >
      <Linkedin class="w-4 h-4 text-primary" slot="icon" aria-hidden="true" />
    </MenuItem>

    <!-- GitHub -->
    <MenuItem
      href="https://github.com/fpmirabile"
      target="_blank"
      title={texts.githubTitle}
      subtitle={texts.githubSubtitle}
    >
      <Github class="w-4 h-4 text-primary" slot="icon" aria-hidden="true" />
    </MenuItem>

    <MenuItem
      as="button"
      id="themeButton"
      title={texts.themeText}
      subtitle={texts.themes.light}
      titleId="themeText"
      subtitleId="currentTheme"
    >
      <Sun
        slot="icon"
        id="themeIconLight"
        class="w-4 h-4 text-primary"
        aria-hidden="true"
      />
      <Moon
        slot="icon"
        id="themeIconDark"
        class="w-4 h-4 text-primary hidden"
        aria-hidden="true"
      />
    </MenuItem>
  </div>

  <!-- Menu Toggle Button -->
  <button
    id="menuToggle"
    class="w-14 h-14 bg-primary text-primary-foreground rounded-full shadow-lg hover:shadow-xl hover:bg-primary/90 transition-all duration-200 flex items-center justify-center"
    aria-label="Toggle menu"
  >
    <Menu id="menuIconOpen" class="w-6 h-6" aria-hidden="true" />
    <X id="menuIconClose" class="w-6 h-6 hidden" aria-hidden="true" />
  </button>
</div>

<script>
  import { eventHandlers, onCustomEvent } from "../../utils/events";
  import { getCurrentLanguage, getThemeTextSync } from "../../utils/language";

  document.addEventListener("DOMContentLoaded", () => {
    let menuOpen = false;

    const menuToggle = document.getElementById("menuToggle");
    const menuItems = document.getElementById("menuItems");
    const menuIconOpen = document.getElementById("menuIconOpen");
    const menuIconClose = document.getElementById("menuIconClose");

    function closeMenu() {
      menuOpen = false;
      menuItems?.classList.remove("menu-open");
      menuItems?.classList.add("pointer-events-none");
      menuIconOpen?.classList.remove("hidden");
      menuIconClose?.classList.add("hidden");
    }

    menuToggle?.addEventListener("click", (event) => {
      event.stopPropagation();
      menuOpen = !menuOpen;

      if (menuOpen) {
        menuItems?.classList.add("menu-open");
        menuItems?.classList.remove("pointer-events-none");
        menuIconOpen?.classList.add("hidden");
        menuIconClose?.classList.remove("hidden");
      } else {
        closeMenu();
      }
    });

    document.addEventListener("click", (event) => {
      if (
        menuOpen &&
        !menuItems?.contains(event.target as Node) &&
        !menuToggle?.contains(event.target as Node)
      ) {
        closeMenu();
      }
    });

    // CV download handler
    const cvButton = document.getElementById("cvButton");
    cvButton?.addEventListener("click", eventHandlers.downloadCV);

    // Theme toggle setup
    const themeButton = document.getElementById("themeButton");
    const themeIconLight = document.getElementById("themeIconLight");
    const themeIconDark = document.getElementById("themeIconDark");
    const currentThemeEl = document.getElementById("currentTheme");

    function applyTheme(isDark: boolean) {
      if (isDark) {
        themeIconLight?.classList.add("hidden");
        themeIconDark?.classList.remove("hidden");
      } else {
        themeIconLight?.classList.remove("hidden");
        themeIconDark?.classList.add("hidden");
      }
    }

    // Apply initial theme
    applyTheme(document.documentElement.classList.contains("dark"));
    // Listen to theme changes
    onCustomEvent("themeChanged", (event) => {
      const { isDark } = event.detail;
      applyTheme(isDark);

      if (currentThemeEl) {
        const currentLang = getCurrentLanguage();
        currentThemeEl.innerText = getThemeTextSync(isDark, currentLang);
      }
    });

    themeButton?.addEventListener("click", eventHandlers.toggleTheme);
  });
</script>
